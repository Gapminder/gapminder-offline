!function(i){var a={};function r(e){if(a[e])return a[e].exports;var t=a[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,r),t.l=!0,t.exports}r.m=i,r.c=a,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)r.d(i,a,function(e){return t[e]}.bind(null,a));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(2);var a,r=i(3),s=(a=r)&&a.__esModule?a:{default:a};t.default=Vizabi.Tool.extend("BubbleChart",{init:function(e,t){this.name="bubblechart",this.components=[{component:s.default,placeholder:".vzb-tool-viz",model:["state.time","state.marker","locale","ui"]},{component:Vizabi.Component.get("timeslider"),placeholder:".vzb-tool-timeslider",model:["state.time","state.marker","ui"]},{component:Vizabi.Component.get("dialogs"),placeholder:".vzb-tool-dialogs",model:["state","ui","locale"]},{component:Vizabi.Component.get("buttonlist"),placeholder:".vzb-tool-buttonlist",model:["state","ui","locale"]},{component:Vizabi.Component.get("treemenu"),placeholder:".vzb-tool-treemenu",model:["state.marker","state.time","locale","ui"]},{component:Vizabi.Component.get("datawarning"),placeholder:".vzb-tool-datawarning",model:["locale"]},{component:Vizabi.Component.get("datanotes"),placeholder:".vzb-tool-datanotes",model:["state.marker","locale"]},{component:Vizabi.Component.get("steppedspeedslider"),placeholder:".vzb-tool-stepped-speed-slider",model:["state.time","locale"]}],this._super(e,t)},validate:function(e){if(e=this.model||e,this._super(e),e.ui.chart.lockNonSelected&&(!e.ui.splash||!1===e.state.time.splash)){var t=e.state.time.parse(""+e.ui.chart.lockNonSelected);t<e.state.time.start&&(e.ui.chart.lockNonSelected=e.state.time.formatDate(e.state.time.start)),t>e.state.time.end&&(e.ui.chart.lockNonSelected=e.state.time.formatDate(e.state.time.end))}},default_model:{state:{time:{autoconfig:{type:"time"}},entities:{autoconfig:{type:"entity_domain",excludeIDs:["tag"]}},entities_colorlegend:{autoconfig:{type:"entity_domain",excludeIDs:["tag"]}},marker:{limit:5e3,space:["entities","time"],axis_x:{use:"indicator",autoconfig:{index:0,type:"measure"}},axis_y:{use:"indicator",autoconfig:{index:1,type:"measure"}},label:{use:"property",autoconfig:{includeOnlyIDs:["name"],type:"string"}},size:{autoconfig:{index:2,type:"measure"}},color:{syncModels:["marker_colorlegend"],autoconfig:{}},size_label:{use:"constant",which:"_default",scaleType:"ordinal",_important:!1,extent:[0,.33],allow:{names:["_default"]}}},marker_colorlegend:{space:["entities_colorlegend"],label:{use:"property",which:"name"},hook_rank:{use:"property",which:"rank"},hook_geoshape:{use:"property",which:"shape_lores_svg"}}},locale:{},ui:{chart:{decorations:{enabled:!0,xAxisGroups:null},superhighlightOnMinimapHover:!0,whenHovering:{showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0},labels:{dragging:!0,removeLabelBox:!1},margin:{left:0,top:0},trails:!0,lockNonSelected:0},datawarning:{doubtDomain:[],doubtRange:[]},show_ticks:!0,presentation:!1,panWithArrow:!1,adaptMinMaxZoom:!1,cursorMode:"arrow",zoomOnScrolling:!1,buttons:["colors","find","zoom","trails","lock","moreoptions","presentation","sidebarcollapse","fullscreen"],dialogs:{popup:["colors","find","size","zoom","moreoptions"],sidebar:["colors","find","size","zoom"],moreoptions:["opacity","speed","axes","size","colors","label","zoom","presentation","technical","about"]}}},versionInfo:{version:"2.4.1",build:1547630126787}})},function(e,t,i){},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(r(4)),o=i(r(7));function i(e){return e&&e.__esModule?e:{default:e}}var S=Vizabi.utils,a=Vizabi.helpers,l=a.svgexport,n=a.labels,c=a["d3.axisWithLabelPicker"],h=a["d3.dynamicBackground"],d=Vizabi.iconset,u=d.warn,m=d.question,g=Vizabi.Component.extend("bubblechart",{init:function(e,t){var i=this,a=this;this.name="bubblechart",this.template=r(8),this.model_expects=[{name:"time",type:"time"},{name:"marker",type:"marker"},{name:"locale",type:"locale"},{name:"ui",type:"ui"}],this.model_binds={"change:time.playing":function(e,t){S.isTouchDevice()&&a.model.time.playing&&a.someHighlighted&&a.model.marker.clearHighlighted()},"change:time.start":function(e,t){a._readyOnce&&!a.model.time.splash&&(["color","axis_x","axis_y"].filter(function(e){return a.model.marker[e].which==a.model.time.dim}).length?a.ready():a._trails.create().then(function(){a._trails.run(["findVisible","reveal","opacityHandler"])}))},"change:time.end":function(e,t){a._readyOnce&&!a.model.time.splash&&(["color","axis_x","axis_y"].filter(function(e){return a.model.marker[e].which==a.model.time.dim}).length?a.ready():a._trails.create().then(function(){a._trails.run(["findVisible","reveal","opacityHandler"])}))},"change:time.record":function(){a.model.time.record?a._export.open(this.element,this.name):a._export.reset()},"change:ui.chart.trails":function(e){a._readyOnce&&(a._trails.toggle(a.model.ui.chart.trails),a.redrawDataPoints())},"change:ui.chart.lockNonSelected":function(e){a._readyOnce&&a.redrawDataPoints(500)},"change:ui.chart.decorations":function(e){a._readyOnce&&a._updateDecorations(500)},"change:ui.chart.showForecastOverlay":function(e){a._readyOnce&&a._updateForecastOverlay()},"change:marker":function(e,t){if(a._readyOnce)if(-1<t.indexOf("scaleType"))a.ready();else if(-1===t.indexOf("marker.color")&&-1===t.indexOf("marker.size")&&-1===t.indexOf("marker.size_label"))if(-1<t.indexOf("domainMin")||-1<t.indexOf("domainMax")){if(!a.yScale||!a.xScale)return;a.updateSize(),a.updateMarkerSizeLimits(),a._trails.run("findVisible"),a.redrawDataPoints(),a._trails.run("resize",null,500)}else if(-1<t.indexOf("zoomedMin")||-1<t.indexOf("zoomedMax")){if(a.draggingNow)return;if(S.approxEqual(a._zoomedXYMinMax.axis_x.zoomedMin,a.model.marker.axis_x.zoomedMin,.01)&&S.approxEqual(a._zoomedXYMinMax.axis_x.zoomedMax,a.model.marker.axis_x.zoomedMax,.01)&&S.approxEqual(a._zoomedXYMinMax.axis_y.zoomedMin,a.model.marker.axis_y.zoomedMin,.01)&&S.approxEqual(a._zoomedXYMinMax.axis_y.zoomedMax,a.model.marker.axis_y.zoomedMax,.01))return;var i=!1;a.model.time.playing&&(i=!0,a.model.time.pause(!0)),a._trails.run("abortAnimation"),a._panZoom.zoomToMaxMin(a.model.marker.axis_x.getZoomedMin(),a.model.marker.axis_x.getZoomedMax(),a.model.marker.axis_y.getZoomedMin(),a.model.marker.axis_y.getZoomedMax(),500,"don't feed these zoom values back to state"),i&&(a.model.time.postponePause=!1)}},"change:marker.select":function(e,t){a._readyOnce&&a.entityBubbles&&(50<(e.source._val||[]).length-(e.source._previousVal||[]).length&&(a.model.ui.chart.trails=!1),a.selectDataPoints(),a.redrawDataPoints(),a._trails.create().then(function(){a._trails.run(["findVisible","reveal","opacityHandler"])}),a.updateBubbleOpacity(),a._updateDoubtOpacity())},"change:marker.superHighlight":function(e,t){i._readyOnce&&i._blinkSuperHighlighted()},"change:marker.highlight":function(e,t){if(a._readyOnce)if("highlight"==t)a.highlightDataPoints();else if(null!==t){var i=a._formatSTitleValues(t.size,t.color);a._updateSTitle(i[0],i[1])}else a._updateSTitle()},"change:time.value":function(){var e;!a.model.time.splash&&a._readyOnce&&a.entityBubbles&&(a.calculationQueue?a.calculationQueue.push(a.model.time.value.toString()):a.calculationQueue=[a.model.time.value.toString()],e=a.model.time.value,a.model.marker.getFrame(e,function(e,t){if(!a._frameIsValid(e))return S.warn("change:time.value: empty data received from marker.getFrame(). doing nothing");var i=a.calculationQueue.indexOf(t.toString());-1!=i&&(a.calculationQueue.splice(0,i+1),a.frameChanged(e,t))}))},"change:ui.adaptMinMaxZoom":function(){a.model.ui.adaptMinMaxZoom?a._panZoom.expandCanvas(500):a._panZoom.reset()},"change:marker.size.extent":function(e,t){a._readyOnce&&(a.updateMarkerSizeLimits(),a.redrawDataPointsOnlySize(),a._trails.run("resize"))},"change:marker.color":function(e,t){a._readyOnce&&(a.redrawDataPointsOnlyColors(),a._trails.run("recolor"))},"change:marker.opacitySelectDim":function(){a.updateBubbleOpacity()},"change:marker.opacityRegular":function(){a.updateBubbleOpacity(),a._trails.run("opacityHandler")},"change:ui.cursorMode":function(){var e=a.chartSvg;"plus"===a.model.ui.cursorMode?(e.classed("vzb-zoomin",!0),e.classed("vzb-zoomout",!1),e.classed("vzb-panhand",!1)):"minus"===a.model.ui.cursorMode?(e.classed("vzb-zoomin",!1),e.classed("vzb-zoomout",!0),e.classed("vzb-panhand",!1)):"hand"===a.model.ui.cursorMode?(e.classed("vzb-zoomin",!1),e.classed("vzb-zoomout",!1),e.classed("vzb-panhand",!0)):(e.classed("vzb-zoomin",!1),e.classed("vzb-zoomout",!1),e.classed("vzb-panhand",!1))},"change:marker.space":function(){a.someHighlighted&&a.model.marker.clearHighlighted(),a.someSelected&&a.model.marker.clearSelected()},ready:function(){}},this._super(e,t),this.xScale=null,this.yScale=null,this.sScale=null,this.cScale=null,this.xAxis=c("bottom"),this.yAxis=c("left"),a.COLOR_BLACKISH="#333",a.COLOR_WHITEISH="#fdfdfd",this.isCanvasPreviouslyExpanded=!1,this.draggingNow=null,this._trails=new s.default(this),this._panZoom=new o.default(this),this._export=new l(this),this._export.prefix("vzb-bc-").deleteClasses(["vzb-bc-bubbles-crop","vzb-hidden","vzb-bc-year","vzb-bc-zoom-rect","vzb-bc-projection-x","vzb-bc-projection-y","vzb-bc-axis-c-title"]),this._labels=new n(this),this._labels.config({CSS_PREFIX:"vzb-bc",LABELS_CONTAINER_CLASS:"vzb-bc-labels",LINES_CONTAINER_CLASS:"vzb-bc-bubbles",LINES_CONTAINER_SELECTOR_PREFIX:"bubble-"})},_rangeBump:function(e,t){var i=this.activeProfile.maxRadiusPx/2;if(t=t?-1:1,S.isArray(e)&&1<e.length){var a=e[0],r=e[e.length-1];return a<r?(r-=i*t)<(a+=i*t)&&(a=r=(a+r)/2):r<a&&(a-=i*t)<(r+=i*t)&&(a=r=(a+r)/2),[a,r]}S.warn("rangeBump error: input is not an array or empty")},readyOnce:function(){var r=this;this._readyOnce=!1,this.scrollableAncestor=S.findScrollableAncestor(this.element),this.element=d3.select(this.element),this.chartSvg=this.element.select("svg"),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisElContainer=this.graph.select(".vzb-bc-axis-y"),this.yAxisEl=this.yAxisElContainer.select("g"),this.xAxisElContainer=this.graph.select(".vzb-bc-axis-x"),this.xAxisEl=this.xAxisElContainer.select("g"),this.ySubTitleEl=this.graph.select(".vzb-bc-axis-y-subtitle"),this.xSubTitleEl=this.graph.select(".vzb-bc-axis-x-subtitle"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.xTitleEl=this.graph.select(".vzb-bc-axis-x-title"),this.sTitleEl=this.graph.select(".vzb-bc-axis-s-title"),this.cTitleEl=this.graph.select(".vzb-bc-axis-c-title"),this.yearEl=this.graph.select(".vzb-bc-year"),this.year=new h(this.yearEl),this.yInfoEl=this.graph.select(".vzb-bc-axis-y-info"),this.xInfoEl=this.graph.select(".vzb-bc-axis-x-info"),this.dataWarningEl=this.graph.select(".vzb-data-warning"),this.projectionX=this.graph.select(".vzb-bc-projection-x"),this.projectionY=this.graph.select(".vzb-bc-projection-y"),this.decorationsEl=this.graph.select(".vzb-bc-decorations"),this.lineEqualXY=this.decorationsEl.select(".vzb-bc-line-equal-xy"),this.xAxisGroupsEl=this.decorationsEl.select(".vzb-bc-x-axis-groups"),this.trailsContainer=this.graph.select(".vzb-bc-trails"),this.bubbleContainerCrop=this.graph.select(".vzb-bc-bubbles-crop"),this.zoomSelection=this.graph.select(".vzb-zoom-selection"),this.labelsContainerCrop=this.graph.select(".vzb-bc-labels-crop"),this.bubbleContainer=this.graph.select(".vzb-bc-bubbles"),this.labelsContainer=this.graph.select(".vzb-bc-labels"),this.linesContainer=this.graph.select(".vzb-bc-lines"),this.zoomRect=this.element.select(".vzb-bc-zoom-rect"),this.eventArea=this.element.select(".vzb-bc-eventarea"),this.forecastOverlay=this.element.select(".vzb-bc-forecastoverlay"),this.entityBubbles=null,this.bubbleCrown=this.element.select(".vzb-bc-bubble-crown"),this.bubbleCrown.selectAll(".vzb-crown-glow").attr("filter","url("+location.pathname+"#vzb-glow-filter)"),this.tooltipMobile=this.element.select(".vzb-tooltip-mobile"),this.on("resize",function(){var e,t,i,a;(r._trails.run("abortAnimation"),r.updateSize())||(r.updateMarkerSizeLimits(),r._labels.updateSize(),e=r._zoomedXYMinMax.axis_x.zoomedMin,t=r._zoomedXYMinMax.axis_x.zoomedMax,i=r._zoomedXYMinMax.axis_y.zoomedMin,a=r._zoomedXYMinMax.axis_y.zoomedMax,r._panZoom.zoomer.dontFeedToState=!0,r._panZoom.rerun(),r._panZoom.zoomToMaxMin(e,t,i,a,0,!0))}),d3.select("body").on("keydown",function(){"arrow"!==r.model.ui.cursorMode&&"hand"!==r.model.ui.cursorMode||(d3.event.metaKey||d3.event.ctrlKey)&&r.element.select("svg").classed("vzb-zoomin",!0)}).on("keyup",function(){"arrow"!==r.model.ui.cursorMode&&"hand"!==r.model.ui.cursorMode||d3.event.metaKey||d3.event.ctrlKey||r.element.select("svg").classed("vzb-zoomin",!1)}).on("mouseenter",function(){"arrow"!==r.model.ui.cursorMode&&"hand"!==r.model.ui.cursorMode||d3.event.metaKey||d3.event.ctrlKey||r.element.select("svg").classed("vzb-zoomin",!1)}),this.root.on("resetZoom",function(){r._panZoom.reset(null,500)}),this._panZoom.zoomSelection(this.bubbleContainerCrop),this.bubbleContainerCrop.call(this._panZoom.dragRectangle).call(this._panZoom.zoomer).on("dblclick.zoom",null).on("mouseup",function(){r.draggingNow=!1}).on("click",function(){var e=r.model.ui.cursorMode;d3.event.defaultPrevented||"arrow"===e||"hand"===e||r._panZoom.zoomByIncrement(e,500)}),this.TIMEDIM=this.model.time.getDimension(),this.KEYS=S.unique(this.model.marker._getAllDimensions({exceptType:"time"})),this.KEY=this.KEYS.join(","),this.dataKeys=this.model.marker.getDataKeysPerHook(),this.updateUIStrings(),this.wScale=d3.scaleLinear().domain(this.model.ui.datawarning.doubtDomain).range(this.model.ui.datawarning.doubtRange),this._labels.readyOnce(),r._readyOnce=!0},_frameIsValid:function(e){return!(!e||0===Object.keys(e.axis_y).length||0===Object.keys(e.axis_x).length||0===Object.keys(e.size).length)},ready:function(){var i=this;this.KEYS=S.unique(this.model.marker._getAllDimensions({exceptType:"time"})),this.KEY=this.KEYS.join(","),this.dataKeys=this.model.marker.getDataKeysPerHook(),this.updateUIStrings();this.model.time.end;this.updateIndicators(),this.updateTime(),i.model.time.splash||i._trails.create(),this.model.marker.getFrame(this.model.time.value,function(e,t){if(t.toString()==i.model.time.value.toString()){if(!i._frameIsValid(e))return S.warn("ready: empty data received from marker.getFrame(). doing nothing");i.frame=e,i.updateSize(),i.updateMarkerSizeLimits(),i.updateEntities(),i._labels.ready(),i.redrawDataPoints(),i.selectDataPoints(),i.updateBubbleOpacity(),i._updateDoubtOpacity(),i.zoomToMarkerMaxMin(),i.model.time.splash||i._trails.run(["findVisible","reveal","opacityHandler"]),i.model.ui.adaptMinMaxZoom&&i._panZoom.expandCanvas()}else S.defer(function(){i.ready()})})},zoomToMarkerMaxMin:function(){this._panZoom.resetZoomState();var e=this.model.marker.axis_x,t=this.model.marker.axis_y,i=(e.getScale().domain(),t.getScale().domain(),e.getZoomedMin()),a=e.getZoomedMax(),r=t.getZoomedMin(),s=t.getZoomedMax();this._panZoom.zoomToMaxMin(i,a,r,s,0,"don't feed these zoom values back to state")},updateIndicators:function(){this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.sScale=this.model.marker.size.getScale(),this.cScale=this.model.marker.color.getScale(),this._labels.setScales(this.xScale,this.yScale),this.yAxis.tickFormat(this.model.marker.axis_y.getTickFormatter()),this.xAxis.tickFormat(this.model.marker.axis_x.getTickFormatter())},frameChanged:function(e,t){this.frame=e,this.updateTime(),this._updateDoubtOpacity(),this._trails.run("findVisible"),this.model.ui.adaptMinMaxZoom?this._panZoom.expandCanvas():this.redrawDataPoints(),this._trails.run("reveal",null,this.duration),this.tooltipMobile.classed("vzb-hidden",!0),this._reorderEntities()},_getSubtitle:function(e,t){var i=e.replace(t,"");","===i[0]&&(i=i.slice(1));var a=/^\((.*)\)$|.*/.exec(i.trim());return a[1]||a[0]||""},updateUIStrings:function(){var r=this,e=(this.getLayoutProfile(),r.model.marker.axis_y.getConceptprops()),t=r.model.marker.axis_x.getConceptprops(),i=r.model.marker.size.getConceptprops(),a=r.model.marker.color.getConceptprops();this.translator=this.model.locale.getTFunction(),this.strings={title:{Y:e.name,X:t.name,S:i.name,C:a.name},title_short:{Y:e.name_short,X:t.name_short,S:i.name_short,C:a.name_short},subtitle:{Y:this._getSubtitle(e.name,e.name_short),X:this._getSubtitle(t.name,t.name_short),S:i.name_short,C:a.name_short},unit:{Y:e.unit||"",X:t.unit||"",S:i.unit||"",C:a.unit||""}},this.ySubTitleEl.selectAll("text").data([0]).enter().append("text"),this.xSubTitleEl.selectAll("text").data([0]).enter().append("text");var s=this.yTitleEl.selectAll("text").data([0]);s.enter().append("text"),s.on("click",function(){r.parent.findChildByName("gapminder-treemenu").markerID("axis_y").alignX(r.model.locale.isRTL()?"right":"left").alignY("top").updateView().toggle()});var o=this.xTitleEl.selectAll("text").data([0]);o.enter().append("text"),o.on("click",function(){r.parent.findChildByName("gapminder-treemenu").markerID("axis_x").alignX(r.model.locale.isRTL()?"right":"left").alignY("bottom").updateView().toggle()});var l=this.sTitleEl.selectAll("text").data([0]);l.enter().append("text"),l.attr("text-anchor","end"),S.setIcon(this.dataWarningEl,u).select("svg").attr("width","0px").attr("height","0px"),this.dataWarningEl.append("text").attr("text-anchor","end").text(this.translator("hints/dataWarning")),S.setIcon(this.yInfoEl,m).select("svg").attr("width","0px").attr("height","0px").style("opacity",Number(Boolean(e.description||e.sourceLink))),S.setIcon(this.xInfoEl,m).select("svg").attr("width","0px").attr("height","0px").style("opacity",Number(Boolean(t.description||t.sourceLink))),this.yInfoEl.on("click",function(){r.parent.findChildByName("gapminder-datanotes").pin()}),this.yInfoEl.on("mouseover",function(){var e=this.getBBox(),t=S.makeAbsoluteContext(this,this.farthestViewportElement)(e.x-10,e.y+e.height+10),i=r.root.element.getBoundingClientRect(),a=r.element.node().getBoundingClientRect();r.parent.findChildByName("gapminder-datanotes").setHook("axis_y").show().setPos(t.x+a.left-i.left,t.y)}),this.yInfoEl.on("mouseout",function(){r.parent.findChildByName("gapminder-datanotes").hide()}),this.xInfoEl.on("click",function(){r.parent.findChildByName("gapminder-datanotes").pin()}),this.xInfoEl.on("mouseover",function(){if(!r.model.time.dragging){var e=this.getBBox(),t=S.makeAbsoluteContext(this,this.farthestViewportElement)(e.x-10,e.y+e.height+10),i=r.root.element.getBoundingClientRect(),a=r.element.node().getBoundingClientRect();r.parent.findChildByName("gapminder-datanotes").setHook("axis_x").show().setPos(t.x+a.left-i.left,t.y)}}),this.xInfoEl.on("mouseout",function(){r.model.time.dragging||r.parent.findChildByName("gapminder-datanotes").hide()}),this.dataWarningEl.on("click",function(){r.parent.findChildByName("gapminder-datawarning").toggle()}).on("mouseover",function(){r._updateDoubtOpacity(1)}).on("mouseout",function(){r._updateDoubtOpacity()})},_updateDoubtOpacity:function(e){null==e&&(e=this.wScale(+this.model.time.formatDate(this.time))),this.someSelected&&(e=1),this.dataWarningEl.style("opacity",e)},updateEntities:function(){var a=this,r=this.dataKeys=this.model.marker.getDataKeysPerHook(),s=this.KEYS,o=this.KEY,l=this.TIMEDIM,n=this.model.time.end,e=function(i){return i=i||"",a.model.marker.getKeys().map(function(e){var t=Object.assign({},e);return t[l]=n,t.sortValue=a.frame.size[S.getKey(e,r.size)]||0,t[o]=i+S.getKey(e,s),t}).sort(function(e,t){return t.sortValue-e.sortValue})}.call(this);this.model.marker.setVisible(e),this.model.time.splash||this.unselectBubblesWithNoData(e),this.entityBubbles=this.bubbleContainer.selectAll("circle.vzb-bc-entity").data(this.model.marker.getVisible(),function(e){return e[o]}),this.entityBubbles.exit().remove(),this.entityBubbles=this.entityBubbles.enter().append("circle").attr("class",function(e){return"vzb-bc-entity bubble-"+e[o]}).on("mouseover",function(e,t){S.isTouchDevice()||"arrow"!==a.model.ui.cursorMode&&"hand"!==a.model.ui.cursorMode||a._bubblesInteract().mouseover(e,t)}).on("mouseout",function(e,t){S.isTouchDevice()||"arrow"!==a.model.ui.cursorMode&&"hand"!==a.model.ui.cursorMode||a._bubblesInteract().mouseout(e,t)}).on("click",function(e,t){S.isTouchDevice()||"arrow"!==a.model.ui.cursorMode&&"hand"!==a.model.ui.cursorMode||a._bubblesInteract().click(e,t)}).onTap(function(e,t){d3.event.stopPropagation(),a._bubblesInteract().click(e,t)}).onLongTap(function(e,t){}).merge(this.entityBubbles),this._reorderEntities()},unselectBubblesWithNoData:function(e){var t=this.KEYS,i=this.KEY;if(this.model.marker.select.length){var a=[],r=e.map(function(e){return e[i]});this.model.marker.select.forEach(function(e){-1!==r.indexOf(S.getKey(e,t))&&a.push(e)}),a.length!==this.model.marker.select.length&&(this.model.marker.select=a)}},_reorderEntities:function(){var r=this,s=this.dataKeys,o=this.KEY;this.bubbleContainer.selectAll(".vzb-bc-entity").sort(function(e,t){var i=r.frame.size[S.getKey(e,s.size)],a=r.frame.size[S.getKey(t,s.size)];return void 0===i&&void 0!==a?-1:void 0!==i&&void 0===a?1:i!=a?d3.descending(i,a):e[o]!=t[o]?d3.ascending(e[o],t[o]):void 0!==e.trailStartTime||void 0!==t.trailStartTime?void 0!==e.trailStartTime?-1:1:void 0!==e.status||void 0!==t.status?void 0!==e.status?-1:1:d3.descending(i,a)})},_bubblesInteract:function(){var a=this;this.KEY,this.TIMEDIM;return{mouseover:function(e,t){a.model.marker.highlightMarker(e),a._labels.showCloseCross(e,!0)},mouseout:function(e,t){a.model.marker.clearHighlighted(),a._labels.showCloseCross(e,!1)},click:function(e,t){if(!a.draggingNow){var i=a.model.marker.isSelected(e);a.model.marker.selectMarker(e),S.isTouchDevice()||(i&&a.model.marker.highlightMarker(e),a.highlightDataPoints())}}}},updateTime:function(){this.time_1=null==this.time?this.model.time.value:this.time,this.time=this.model.time.value,this.duration=this.model.time.playing&&0<this.time-this.time_1?this.model.time.delayAnimations:0,this.year.setText(this.model.time.formatDate(this.time,"ui"),this.duration),this._updateForecastOverlay()},updateSize:function(){var e=this.chartSvg,i=S.px2num(e.style("width")),a=S.px2num(e.style("height")),t=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return e+a*t},r=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return e+i*t},s={small:{margin:{top:30,bottom:35,left:30,right:10},leftMarginRatio:1,padding:2,minRadiusPx:.5,maxRadiusEm:this.model.ui.chart.maxRadiusEm||.05,infoElHeight:16,yAxisTitleBottomMargin:6,xAxisTitleBottomMargin:4},medium:{margin:{top:15,bottom:40,left:40,right:15},leftMarginRatio:1.6,padding:2,minRadiusPx:1,maxRadiusEm:this.model.ui.chart.maxRadiusEm||.05,infoElHeight:20,yAxisTitleBottomMargin:3,xAxisTitleBottomMargin:4},large:{margin:{top:15,bottom:t(30,.03),left:r(31,.015),right:20},leftMarginRatio:1.8,padding:2,minRadiusPx:1,maxRadiusEm:this.model.ui.chart.maxRadiusEm||.05,infoElHeight:22,yAxisTitleBottomMargin:3,xAxisTitleBottomMargin:t(0,.01),hideSTitle:!0}},o={medium:{margin:{top:20,bottom:55,left:50,right:20},yAxisTitleBottomMargin:3,xAxisTitleBottomMargin:4,infoElHeight:26},large:{margin:{top:30,bottom:t(45,.03),left:r(35,.025),right:30},yAxisTitleBottomMargin:3,xAxisTitleBottomMargin:t(-10,.01),infoElHeight:32,hideSTitle:!0}},l=this;this.activeProfile=this.getActiveProfile(s,o);var n=this.getLayoutProfile(),c=this.root.getVizWidthHeight();this.activeProfile.maxRadiusPx=Math.max(this.activeProfile.minRadiusPx,this.activeProfile.maxRadiusEm*S.hypotenuse(c.width,c.height));var h=this.activeProfile.margin,d=this.activeProfile.infoElHeight;if(l._labels.setCloseCrossHeight(1.2*l.activeProfile.infoElHeight),l._labels.setTooltipFontSize(l.activeProfile.infoElHeight+"px"),this.height=parseInt(this.element.style("height"),10)-h.top-h.bottom||0,this.width=parseInt(this.element.style("width"),10)-h.left*this.activeProfile.leftMarginRatio-h.right||0,(this.height<=0||this.width<=0)&&(this.height=0,this.width=0,S.warn("Bubble chart updateSize(): vizabi container is too little or has display:none")),this.graph.attr("transform","translate("+h.left*this.activeProfile.leftMarginRatio+","+h.top+")"),this.year.resize(this.width,this.height),this.eventArea.attr("width",this.width).attr("height",Math.max(0,this.height)),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range(this._rangeBump([this.height,0])):this.yScale.rangePoints([this.height,0],l.activeProfile.padding).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range(this._rangeBump([0,this.width])):this.xScale.rangePoints([0,this.width],l.activeProfile.padding).range(),this.yAxis.scale(this.yScale).tickSizeInner(-this.width).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.width,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:h,limitMaxTickNumber:6,bump:this.activeProfile.maxRadiusPx/2,viewportLength:this.height,formatter:this.model.marker.axis_y.getTickFormatter()}),this.xAxis.scale(this.xScale).tickSizeInner(-this.height).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.height,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:h,bump:this.activeProfile.maxRadiusPx/2,viewportLength:this.width,formatter:this.model.marker.axis_x.getTickFormatter()}),this.bubbleContainerCrop.attr("width",this.width).attr("height",Math.max(0,this.height)),this.labelsContainerCrop.attr("width",this.width).attr("height",Math.max(0,this.height)),this.xAxisElContainer.attr("width",this.width+1).attr("height",this.activeProfile.margin.bottom+this.height).attr("y",-1).attr("x",-1),this.xAxisEl.attr("transform","translate(1,"+(1+this.height)+")"),this.yAxisElContainer.attr("width",this.activeProfile.margin.left+this.width).attr("height",Math.max(0,this.height)).attr("x",-this.activeProfile.margin.left),this.yAxisEl.attr("transform","translate("+(this.activeProfile.margin.left-1)+",0)"),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis),this.projectionX.attr("y1",l.yScale.range()[0]+this.activeProfile.maxRadiusPx/2),this.projectionY.attr("x2",l.xScale.range()[0]-this.activeProfile.maxRadiusPx/2),this._updateSTitle(),this.sTitleEl.attr("transform","translate("+this.width+",20) rotate(-90)"),"small"!==n)this.ySubTitleEl.select("text").attr("dy",.6*d).text(this.strings.subtitle.Y),this.xSubTitleEl.select("text").attr("dy",.3*-d).text(this.strings.subtitle.X),this.yTitleEl.select("text").text(this.strings.title_short.Y+" ").append("tspan").style("font-size",.7*d+"px").text("▼"),this.xTitleEl.select("text").text(this.strings.title_short.X+" ").append("tspan").style("font-size",.7*d+"px").text("▼");else{this.ySubTitleEl.select("text").text(""),this.xSubTitleEl.select("text").text("");var u=this.yTitleEl.select("text").text(this.strings.title.Y);u.node().getBBox().width>this.width&&u.text(this.strings.title_short.Y);var m=this.xTitleEl.select("text").text(this.strings.title.X);m.node().getBBox().width>this.width-100&&m.text(this.strings.title_short.X)}var g=this.model.locale.isRTL();if(this.ySubTitleEl.style("font-size",.8*d+"px").attr("transform","translate(0,0) rotate(-90)"),this.xSubTitleEl.style("font-size",.8*d+"px").attr("transform","translate("+this.width+","+this.height+")"),this.yTitleEl.style("font-size",d+"px").attr("transform","small"!==n?"translate("+(-h.left-this.activeProfile.yAxisTitleBottomMargin)+","+.5*this.height+") rotate(-90)":"translate("+(g?this.width:10-this.activeProfile.margin.left)+", -"+this.activeProfile.yAxisTitleBottomMargin+")"),this.xTitleEl.style("font-size",d+"px").attr("transform","small"!==n?"translate("+.5*this.width+","+(this.height+h.bottom-this.activeProfile.xAxisTitleBottomMargin)+")":"translate("+(g?this.width:0)+","+(this.height+h.bottom-this.activeProfile.xAxisTitleBottomMargin)+")"),this.xAxisGroupsEl.style("font-size",.8*d+"px"),this.yInfoEl.select("svg").node()){var x=this.yTitleEl.node().getBBox(),v=S.transform(this.yTitleEl.node()),b=g?x.x+v.translateX-1.4*d:x.x+v.translateX+x.width+.4*d,y=g?v.translateY+1.4*d+.5*x.width:v.translateY-.4*d-.5*x.width;this.yInfoEl.select("svg").attr("width",d+"px").attr("height",d+"px"),this.yInfoEl.attr("transform","small"!==n?"translate("+(v.translateX-.8*d)+","+y+") rotate(-90)":"translate("+b+","+(v.translateY-.8*d)+")")}if(this.xInfoEl.select("svg").node()){var p=this.xTitleEl.node().getBBox(),f=S.transform(this.xTitleEl.node()),_=g?p.x+f.translateX-1.4*d:p.x+f.translateX+p.width+.4*d;this.xInfoEl.select("svg").attr("width",d+"px").attr("height",d+"px"),this.xInfoEl.attr("transform","translate("+_+","+(f.translateY-.8*d)+")")}this._resizeDataWarning(),this.model.ui.chart.margin.set("left",h.left*this.activeProfile.leftMarginRatio,!1,!1)},_updateDecorations:function(n){var r=this,e=this.model.ui.chart.decorations.xAxisGroups&&this.model.ui.chart.decorations.xAxisGroups[this.model.marker.axis_x.which]&&this.model.ui.chart.decorations.enabled&&"small"!==this.getLayoutProfile();if(this.xAxisGroupsEl.classed("vzb-invisible",!e),e){var t=this.model.ui.chart.decorations.xAxisGroups[this.model.marker.axis_x.which],i=this.xAxisGroupsEl.selectAll(".vzb-bc-x-axis-group").data(t);i.exit().remove(),i=i.enter().append("g").attr("class","vzb-bc-x-axis-group").each(function(){var e=d3.select(this);e.append("text").attr("class","vzb-bc-x-axis-group-line").text("◆").style("text-anchor","middle"),e.append("text").attr("class","vzb-bc-x-axis-group-text")}).merge(i);var c=[],s=!1;i.each(function(e,t){var i=d3.select(this).select("text.vzb-bc-x-axis-group-text").text(r.translator(e.label)),a={min:e.min,max:e.max};a.textHeight=i.node().getBBox().height,a.textWidth=i.node().getBBox().width,a.boundaryMinX_px=r.xScale(e.min||0===e.min?e.min:d3.min(r.xScale.domain())),a.boundaryMaxX_px=r.xScale(e.max||0===e.max?e.max:d3.max(r.xScale.domain())),a.centerX_px=(a.boundaryMinX_px+a.boundaryMaxX_px)/2,a.marginX_px=(Math.abs(a.boundaryMinX_px-a.boundaryMaxX_px)-a.textWidth)/2,a.marginX_px-a.textHeight<0&&(s=!0),c[t]=a}),s&&i.each(function(e,t){var i=d3.select(this).select("text.vzb-bc-x-axis-group-text").text(r.translator(e.label_short)),a=c[t];a.textWidth=i.node().getBBox().width,a.marginX_px=(Math.abs(a.boundaryMinX_px-a.boundaryMaxX_px)-a.textWidth)/2,c[t]=a}),i.each(function(e,t){var i=d3.select(this),a=0==t,r=t==c.length-1,s=c[t],o=s.textHeight/4,l=s.centerX_px;a&&(l=c[t+1].boundaryMinX_px-Math.max(c[t+1].marginX_px,o)),r&&(l=c[t-1].boundaryMaxX_px+Math.max(c[t-1].marginX_px,o));i.select("text.vzb-bc-x-axis-group-text").transition().duration(n||0).style("text-anchor",a?"end":r?"start":"middle").attr("dy","-0.2em").attr("y",s.textHeight).attr("x",l);i.select("text.vzb-bc-x-axis-group-line").classed("vzb-invisible",r).transition().duration(n||0).attr("dy","-0.2em").attr("y",.9*s.textHeight).attr("x",s.boundaryMaxX_px)}),i.select("text.vzb-bc-x-axis-group-text").on("mouseenter",function(e,t){var i=c[t],a=d3.select(this.parentNode);d3.select(this).attr("font-weight","bold"),a.append("rect").lower().attr("x",i.boundaryMinX_px).attr("width",i.boundaryMaxX_px-i.boundaryMinX_px).attr("y",-r.activeProfile.margin.top).attr("height",r.height+r.activeProfile.margin.top),(i.min||0===i.min)&&a.append("line").lower().attr("x1",i.boundaryMinX_px).attr("x2",i.boundaryMinX_px).attr("y1",-r.activeProfile.margin.top).attr("y2",r.height),(i.max||0===i.max)&&a.append("line").lower().attr("x1",i.boundaryMaxX_px).attr("x2",i.boundaryMaxX_px).attr("y1",-r.activeProfile.margin.top).attr("y2",r.height)}).on("mouseleave",function(e,t){var i=d3.select(this.parentNode);d3.select(this).attr("font-weight",null),i.selectAll("rect").remove(),i.selectAll("line").remove()})}var a=this.model.marker.axis_x.which==this.model.marker.axis_y.which&&this.model.ui.chart.decorations.enabled&&"small"!==this.getLayoutProfile();if(this.lineEqualXY.classed("vzb-invisible",!a),a){var o=d3.min(this.yScale.domain().concat(this.xScale.domain())),l=d3.max(this.yScale.domain().concat(this.xScale.domain()));this.lineEqualXY.transition().duration(n||0).attr("y1",this.yScale(o)).attr("y2",this.yScale(l)).attr("x1",this.xScale(o)).attr("x2",this.xScale(l))}},_resizeDataWarning:function(){var e=this.dataWarningEl.select("text").style("font-size",null),t=e.node().getBBox().width+3*e.node().getBBox().height,i=this.width-this.xTitleEl.node().getBBox().width-this.activeProfile.infoElHeight,a=parseInt(e.style("font-size"))*i/t;e.style("font-size",i<t?a+"px":null);var r=e.node().getBBox();this.dataWarningEl.select("svg").attr("width",.75*r.height).attr("height",.75*r.height).attr("x",-r.width-1.2*r.height).attr("y",.65*-r.height),this.dataWarningEl.attr("transform","translate("+(this.model.locale.isRTL()?r.width+r.height:this.width)+","+(this.height+this.activeProfile.margin.bottom-this.activeProfile.xAxisTitleBottomMargin)+")")},updateMarkerSizeLimits:function(){var e=this.model.marker.size.extent||[0,1];if(!this.activeProfile)return S.warn("updateMarkerSizeLimits() is called before ready(). This can happen if events get unfrozen and getFrame() still didn't return data");var t=this.activeProfile.minRadiusPx,i=this.activeProfile.maxRadiusPx,a=S.radiusToArea(Math.max(i*e[0],t)),r=S.radiusToArea(Math.max(i*e[1],t)),s=a===r?[a,r]:d3.range(a,r,(r-a)/this.sScale.domain().length).concat(r);this.sScale.range(s)},redrawDataPointsOnlyColors:function(){var n=this;if(!this.entityBubbles)return S.warn("redrawDataPointsOnlyColors(): no entityBubbles defined. likely a premature call, fix it!");var c=void 0,h=this.dataKeys=this.model.marker.getDataKeysPerHook(),d=this.KEYS,u=this.KEY,e=this.model.time.value;this.model.ui.chart.lockNonSelected&&this.someSelected&&(e=this.model.time.parse(""+this.model.ui.chart.lockNonSelected)),this.model.marker.getFrame(e,function(l){if(!n._frameIsValid(l))return S.warn("redrawDataPointsOnlyColor: empty data received from marker.getFrame(). doing nothing");c=n.frame,n.entityBubbles.each(function(a,r){var e=n.model.marker.isSelected(a),t=e?c.color[S.getKey(a,h.color)]:l.color[S.getKey(a,h.color)],s=null!=t?n.cScale(t):n.COLOR_WHITEISH;if(d3.select(this).style("fill",s),e){var i=S.find(n.model.marker.select,function(e){return S.getKey(e,d)==a[u]}),o=n.model.time.parse(""+i.trailStartTime);n.model.marker.getFrame(o,function(e){if(!e)return S.warn("redrawDataPointsOnlyColor: empty data received from marker.getFrames(). doing nothing");var t={};if(n.model.ui.chart.trails&&o-n.time!=0){var i=e.color[S.getKey(a,h.color)];t.scaledC0=null!=i?n.cScale(i):n.COLOR_WHITEISH}else t.scaledC0=s;n._labels.updateLabelOnlyColor(a,r,t)})}})})},redrawDataPointsOnlySize:function(){var n=this,c=void 0,h=this.dataKeys=this.model.marker.getDataKeysPerHook(),d=this.KEYS,u=this.KEY,e=this.model.time.value;this.model.ui.chart.lockNonSelected&&this.someSelected&&(e=this.model.time.parse(""+this.model.ui.chart.lockNonSelected)),this.model.marker.getFrame(e,function(l){if(!n._frameIsValid(l))return S.warn("redrawDataPointsOnlySize: empty data received from marker.getFrame(). doing nothing");c=n.frame,n.entityBubbles.each(function(i,a){var e=n.model.marker.isSelected(i),t=e?c.size[S.getKey(i,h.size)]:l.size[S.getKey(i,h.size)];if(null!=t){var r=S.areaToRadius(n.sScale(t));if(d3.select(this).attr("r",r),e){var s=S.find(n.model.marker.select,function(e){return S.getKey(e,d)==i[u]}),o=n.model.time.parse(""+s.trailStartTime);n.model.marker.getFrame(o,function(e){if(!e)return S.warn("redrawDataPointsOnlySize: empty data received from marker.getFrames(). doing nothing");var t={};n.model.ui.chart.trails&&o-n.time!=0?t.scaledS0=S.areaToRadius(n.sScale(e.size[S.getKey(i,h.size)])):t.scaledS0=r,n._labels.updateLabelOnlyPosition(i,a,t)})}}})})},redrawDataPoints:function(r){var s=this;this.KEY;if(null==r&&(r=s.duration),this.model.ui.chart.lockNonSelected&&this.someSelected){var e=this.model.time.parse(""+this.model.ui.chart.lockNonSelected);this.model.marker.getFrame(e,function(a){if(!a)return S.warn("redrawDataPoints: empty data received from marker.getFrames(). doing nothing");s.entityBubbles.each(function(e,t){var i=s.model.marker.isSelected(e)?s.frame:a;s._updateBubble(e,i,t,d3.select(this),r)})})}else s.entityBubbles.each(function(e,t){s._updateBubble(e,s.frame,t,d3.select(this),r)});this._updateDecorations(r)},_updateBubble:function(e,t,i,a,r){var s=this,o=this.dataKeys,l=!1,n=t.axis_y[S.getKey(e,o.axis_y)],c=t.axis_x[S.getKey(e,o.axis_x)],h=t.size[S.getKey(e,o.size)],d=t.label[S.getKey(e,o.label)],u=t.color[S.getKey(e,o.color)],m=t.size_label[S.getKey(e,o.size_label)];if(!n&&0!==n||!c&&0!==c||!h&&0!==h){if(e.hidden||(l=e.hidden=!0),l)if(r){var g=a.style("opacity");a.transition().duration(r).ease(d3.easeExp).style("opacity",0).on("end",function(){a.classed("vzb-invisible",e.hidden),a.style("opacity",g)})}else a.classed("vzb-invisible",e.hidden)}else{(e.hidden||a.classed("vzb-invisible"))&&(l=!(e.hidden=!1));var x=S.areaToRadius(s.sScale(h));if(a.style("fill",null!=u?s.cScale(u):s.COLOR_WHITEISH),r)if(l){var v=a.style("opacity");a.classed("vzb-invisible",e.hidden),a.style("opacity",0).attr("cy",s.yScale(n)).attr("cx",s.xScale(c)).attr("r",x).transition().duration(r).ease(d3.easeExp).style("opacity",v)}else a.transition().duration(r).ease(d3.easeLinear).attr("cy",s.yScale(n)).attr("cx",s.xScale(c)).attr("r",x);else a.interrupt().attr("cy",s.yScale(n)).attr("cx",s.xScale(c)).attr("r",x).transition(),l&&a.classed("vzb-invisible",e.hidden);this.model.time.record&&s._export.write({type:"circle",id:e[KEY],time:this.model.time.value.getUTCFullYear(),fill:null!=u?s.cScale(u):s.COLOR_WHITEISH,cx:s.xScale(c),cy:s.yScale(n),r:x})}s._updateLabel(e,i,t,c,n,h,u,d,m,r,l)},_updateLabel:function(t,e,i,a,r,s,o,l,n,c,h){var d=this,u=this.KEYS,m=this.KEY;if(d.model.marker.isSelected(t)){var g={},x=S.find(d.model.marker.select,function(e){return S.getKey(e,u)==t[m]}),v=d.model.time.formatDate(d.time);this.model.ui.chart.trails&&x.trailStartTime!=v&&null!=x.trailStartTime||(this.model.ui.chart.trails&&null==x.trailStartTime&&(x.trailStartTime=v),g.labelX0=a,g.labelY0=r,g.scaledC0=null!=o?d.cScale(o):d.COLOR_WHITEISH,g.scaledS0=s||0===s?S.areaToRadius(d.sScale(s)):null);var b=d.model.time.parse(""+x.trailStartTime),y=d._getLabelText(i,t,x.trailStartTime);h&&t.hidden&&d.model.ui.chart.trails&&b&&b<d.time&&(h=!1),t.hidden&&!d.model.ui.chart.trails&&(h=!0),this._labels.updateLabel(t,e,g,a,r,s,o,y,n,c,h)}},_getLabelText:function(e,t,i){return this.model.marker.getCompoundLabelText(t,e)+(i&&this.model.time.start-this.model.time.end!=0?" "+i:"")},_updateForecastOverlay:function(){this.forecastOverlay.classed("vzb-hidden",this.model.time.value<=this.model.time.endBeforeForecast||!this.model.time.endBeforeForecast||!this.model.ui.chart.showForecastOverlay)},_setTooltip:function(e,t,i,a,r,s){if(e){var o={};if(s){var l=this.dataKeys,n=this.frame;o.valueY=n.axis_y[S.getKey(s,l.axis_y)],o.valueX=n.axis_x[S.getKey(s,l.axis_x)],o.valueS=n.size[S.getKey(s,l.size)],o.valueC=n.color[S.getKey(s,l.color)],o.valueLST=n.size_label[S.getKey(s,l.size_label)],o.labelText=this._getLabelText(n,s,this.model.time.formatDate(this.time))}var c={};c.labelX0=this.xScale.invert(t),c.labelY0=this.yScale.invert(i),c.scaledS0=a,c.scaledC0=null,this._labels.setTooltip(s,e,c,o)}else this._labels.setTooltip()},_formatSTitleValues:function(e,t){var i=this.strings.unit.S,a=this.strings.unit.C,r=this.model.marker.size.getTickFormatter(),s=this.model.marker.color.getTickFormatter();return this.model.marker.color.isDiscrete()&&"constant"!==this.model.marker.color.use&&t&&this.model.marker.color.getColorlegendMarker()&&(t=this.model.marker.color.getColorlegendMarker().label.getItems()[t]||""),[r(e)+" "+i,t||0===t?s(t)+" "+a:this.translator("hints/nodata")]},_updateSTitle:function(e,t){if(this.activeProfile.hideSTitle&&-1<this.model.ui.dialogs.sidebar.indexOf("colors")&&-1<this.model.ui.dialogs.sidebar.indexOf("size"))this.sTitleEl.classed("vzb-invisible",!0);else{this.sTitleEl.classed("vzb-invisible")&&this.sTitleEl.classed("vzb-invisible",!1);var i="constant"!==this.model.marker.size.use,a="constant"!==this.model.marker.color.use,r=this.sTitleEl.select("text").style("font-size",null).text((i?this.translator("buttons/size")+": "+(e||this.strings.title.S):"")+(i&&a?", ":"")+(a?this.translator("buttons/colors")+": "+(t||this.strings.title.C):"")),s=r.node().getBBox().width,o=this.height-30,l=parseInt(r.style("font-size"))*o/s;r.style("font-size",o<s?l+"px":null)}},selectDataPoints:function(){var e=this;this.KEY;S.isTouchDevice()?(e.model.marker.clearHighlighted(),e._labels.showCloseCross(null,!1)):(e._setTooltip(),e._setBubbleCrown()),e.someSelected=0<e.model.marker.select.length,e.nonSelectedOpacityZero=!1},_setBubbleCrown:function(e,t,i,a,r){null!=e?(this.bubbleCrown.classed("vzb-hidden",!1),this.bubbleCrown.select(".vzb-crown").attr("cx",e).attr("cy",t).attr("r",i).attr("fill",r?"none":a),this.bubbleCrown.selectAll(".vzb-crown-glow").attr("cx",e).attr("cy",t).attr("r",i+10).attr("stroke",a)):this.bubbleCrown.classed("vzb-hidden",!0)},_axisProjections:function(s){var o=this,e=this.TIMEDIM,l=this.dataKeys;null!=s?this.model.marker.getFrame(s[e],function(e){var t=e.axis_y[S.getKey(s,l.axis_y)],i=e.axis_x[S.getKey(s,l.axis_x)],a=e.size[S.getKey(s,l.size)],r=S.areaToRadius(o.sScale(a));!t&&0!==t||!i&&0!==i||!a&&0!==a||(o.model.ui.chart.whenHovering.showProjectionLineX&&0<o.xScale(i)&&o.xScale(i)<o.width&&o.yScale(t)+r<o.height&&o.projectionX.style("opacity",1).attr("y2",o.yScale(t)+r).attr("x1",o.xScale(i)).attr("x2",o.xScale(i)),o.model.ui.chart.whenHovering.showProjectionLineY&&0<o.yScale(t)&&o.yScale(t)<o.height&&0<o.xScale(i)-r&&o.projectionY.style("opacity",1).attr("y1",o.yScale(t)).attr("y2",o.yScale(t)).attr("x1",o.xScale(i)-r),o.model.ui.chart.whenHovering.higlightValueX&&o.xAxisEl.call(o.xAxis.highlightValue(i)),o.model.ui.chart.whenHovering.higlightValueY&&o.yAxisEl.call(o.yAxis.highlightValue(t)))}):(this.projectionX.style("opacity",0),this.projectionY.style("opacity",0),this.xAxisEl.call(this.xAxis.highlightValue("none")),this.yAxisEl.call(this.yAxis.highlightValue("none")))},highlightDataPoints:function(){var m=this,g=this.TIMEDIM,x=this.dataKeys,v=this.KEYS,b=this.KEY;if(this.someHighlighted=0<this.model.marker.highlight.length,this.updateBubbleOpacity(),1===this.model.marker.highlight.length){var y=S.clone(this.model.marker.highlight[0]);y[b]=S.getKey(y,v),m.model.ui.chart.lockNonSelected&&m.someSelected&&!m.model.marker.isSelected(y)?y[g]=m.model.time.parse(""+m.model.ui.chart.lockNonSelected):y[g]=m.model.time.parse(""+y.trailStartTime)||m.time,m.model.marker.getFrame(y[g],function(e){if(e){var t=m.xScale(e.axis_x[S.getKey(y,x.axis_x)]),i=m.yScale(e.axis_y[S.getKey(y,x.axis_y)]),a=S.areaToRadius(m.sScale(e.size[S.getKey(y,x.size)])),r=null!=e.color[S.getKey(y,x.color)]?m.cScale(e.color[S.getKey(y,x.color)]):m.COLOR_WHITEISH,s=!1,o=m._formatSTitleValues(e.size[S.getKey(y,x.size)],e.color[S.getKey(y,x.color)]);m._updateSTitle(o[0],o[1]),(t+a<0||t-a>m.width||i+a<0||i-a>m.height)&&(s=!0);var l="",n=!1;if(m.model.marker.isSelected(y)&&m.model.ui.chart.trails){l=m.model.time.formatDate(m.time);var c=S.find(m.model.marker.select,function(e){return S.getKey(e,v)==y[b]});n=l!==c.trailStartTime&&!d3.select(d3.event.target).classed("bubble-"+y[b]),l=l!==c.trailStartTime&&m.time===y[g]?l:""}else l=m.model.marker.isSelected(y)?"":m._getLabelText(e,y);if(m._labels.highlight(null,!1),m._labels.highlight(y,!0),m.model.marker.isSelected(y)){var h=!y.trailStartTime||y.trailStartTime==m.model.time.formatDate(m.time);m._setBubbleCrown(t,i,a,r,h)}s||n||m._axisProjections(y),!l||s||n||m._setTooltip(l,t,i,a+3,r,y);var d=S.find(m.model.marker.select,function(e){return S.getKey(e,v)==y[b]});if(d){var u=S.clone(d);u.opacity=1,m._trails.run(["opacityHandler"],u)}}})}else this._axisProjections(),this._trails.run(["opacityHandler"]),m._updateSTitle(),this._setTooltip(),this._setBubbleCrown(),this._labels.highlight(null,!1)},_blinkSuperHighlighted:function(){var t=this;this.entityBubbles.classed("vzb-super-highlighted",function(e){return t.model.marker.isSuperHighlighted(e)})},updateBubbleOpacity:function(e){var t=this,i=this.model.marker.opacityHighlightDim,a=this.model.marker.opacityRegular,r=this.model.marker.opacitySelectDim;this.entityBubbles.style("opacity",function(e){return t.someHighlighted&&t.model.marker.isHighlighted(e)?1:t.someSelected?t.model.marker.isSelected(e)?1:r:t.someHighlighted?i:a});var s=t.model.marker.opacitySelectDim<.01;s!=this.nonSelectedOpacityZero&&this.entityBubbles.style("pointer-events",function(e){return t.someSelected&&s&&!t.model.marker.isSelected(e)?"none":"visible"}),this.nonSelectedOpacityZero=t.model.marker.opacitySelectDim<.01}});t.default=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,r=i(5),l=(a=r)&&a.__esModule?a:{default:a};var z=Vizabi.utils,s=Vizabi.Class.extend({init:function(e){this.context=e,this._isCreated=null,this.actionsQueue={},this.entityTrails={},this.trailsData=[],this.trailsInProgress={},this.activePromises={},this.trailTransitions={},this.delayedIterations={},this.drawingQueue={}},toggle:function(e){var t=this.context;e?t._trails.create().then(function(){t._trails.run(["findVisible","reveal","opacityHandler"])}):(t._trails.run("remove"),t.model.marker.select.forEach(function(e){delete e.trailStartTime}))},create:function(r){var n=this.context,o=this,c=n.KEYS,h=n.KEY,d=n.dataKeys,u=n.TIMEDIM;return this._isCreated=new Promise(function(t,e){if(n.model.ui.chart.trails){var s=n.model.time.getAllSteps(),i=[];r=null==r?n.model.marker.select:[r],o._clearActions(r),o.trailsData=n.model.marker.select.map(function(t){var i={status:"created",selectedEntityData:t};return c.forEach(function(e){return i[e]=t[e]}),i[h]=z.getKey(t,c),i}),o.trailTransitions={};var a=n.bubbleContainer.selectAll("g.vzb-bc-entity.entity-trail").data(o.trailsData,function(e){return e[h]});a.exit().remove(),a.enter().insert("g",function(e){return this.querySelector(".bubble-"+(0,l.default)(e[h]))}).attr("class",function(e){return"vzb-bc-entity entity-trail trail-"+e[h]}).merge(a).each(function(l,e){var r=this;i.push(new Promise(function(e,t){var i=s.map(function(e){return{t:e,key:l[h]}}),a=d3.select(r).selectAll("g").data(i).classed("vzb-invisible",!0);a.exit().remove(),o.entityTrails[l[h]]=a.enter().append("g").attr("class","vzb-bc-trailsegment vzb-invisible").on("mouseover",function(e,t){if(!z.isTouchDevice()){var i={};i[h]=e.key,i[u]=e.t,n._axisProjections(i),n._labels.highlight(l,!0);var s=n.model.time.formatDate(e.t),o=z.find(n.model.marker.select,function(e){return z.getKey(e,c)==l[h]});n.model.marker.getFrame(i[u],function(e){var t=n.xScale(e.axis_x[z.getKey(l,d.axis_x)]),i=n.yScale(e.axis_y[z.getKey(l,d.axis_y)]),a=z.areaToRadius(n.sScale(e.size[z.getKey(l,d.size)])),r=null!=e.color[z.getKey(l,d.color)]?n.cScale(e.color[z.getKey(l,d.color)]):n.COLOR_WHITEISH;s!==o.trailStartTime&&n._setTooltip(s,t,i,a+3,r),n._setBubbleCrown(t,i,a,r),n.model.marker.getModelObject("highlight").trigger("change",{size:e.size[z.getKey(l,d.size)],color:e.color[z.getKey(l,d.color)]})}),d3.select(this).style("opacity",1)}}).on("mouseout",function(e,t){z.isTouchDevice()||(n._axisProjections(),n._setTooltip(),n._setBubbleCrown(),n._labels.highlight(null,!1),n.model.marker.getModelObject("highlight").trigger("change",null),d3.select(this).style("opacity",n.model.marker.opacityRegular))}).each(function(e,t){var i=d3.select(this);i.append("circle"),i.append("line")}).merge(a),e()}))}),0<i.length?Promise.all(i).then(function(e){t(!0)}):t(!0)}}),this._isCreated},_addActions:function(e,i){var t=this.context,a=this,r=t.KEYS;e.forEach(function(e){var t=z.getKey(e,r);a.actionsQueue[t]||(a.actionsQueue[t]=[]),a.actionsQueue[t]=[].concat(a.actionsQueue[t].filter(function(e){return-1==i.indexOf(e)}),i)})},_clearActions:function(e){var t=this.context,i=this,a=t.KEYS;e.forEach(function(e){var t=z.getKey(e,a);i.actionsQueue[t]||(i.actionsQueue[t]=[]),i.actionsQueue[t]=[],i.drawingQueue[t]={},i.delayedIterations[t]={},i.activePromises[t]||(i.activePromises[t]=[]),z.forEach(i.activePromises[t],function(e,t){"pending"===e.status&&e.reject()}),i.trailsInProgress[t]=null,i.activePromises[t]=[]})},_getNextAction:function(e){return this.actionsQueue[e].shift()},run:function(t,i,o){var l=this.context,n=this,c=l.KEY;this._isCreated&&!l.model.time.splash&&("string"==typeof t&&(t=[t]),this._isCreated.then(function(){if(l.model.ui.chart.trails&&l.model.marker.select.length||"remove"==t){o||(o=0),i=null==i?l.model.marker.select:[i];for(var e=0;e<t.length;e++)-1!=["resize","recolor","remove"].indexOf(t[e])&&function(){var i=t.splice(e,1).pop();--e,n.trailsData.forEach(function(e){var t=n.entityTrails[e[c]];l._trails["_"+i](t,o,e)})}();0!=t.length&&(n._addActions(i,t),n.trailsData.forEach(function(r){-1!=t.indexOf("findVisible")&&(n.drawingQueue[r[c]]={},n.delayedIterations[r[c]]={});var s=n.entityTrails[r[c]];n.trailsInProgress[r[c]]||function e(t){var i=n._getNextAction(r[c]);if(i){n.trailsInProgress[r[c]]=i;var a=l._trails["_"+i](s,o,r);a&&a instanceof Promise?a.then(function(){n.trailsInProgress[r[c]]=null,e(t+1)},function(){n.trailsInProgress[r[c]]=null}):(n.trailsInProgress[r[c]]=null,e(t+1))}}(0)}))}}))},_remove:function(e,t,i){this.actionsQueue[i[this.context.KEY]]=[],e&&(d3.select(this.entityTrails[i[this.context.KEY]].node().parentNode).remove(),this.entityTrails[i[this.context.KEY]]=null)},_resize:function(e,s,o){var l=this.context;if(!l.model.time.splash){var n=!1;e.each(function(e,t){if(null!=e.valueY&&null!=e.valueX&&null!=e.valueS){var i=d3.select(this);if(s?i.select("circle").transition().duration(s).ease(d3.easeLinear).attr("cy",l.yScale(e.valueY)).attr("cx",l.xScale(e.valueX)).attr("r",z.areaToRadius(l.sScale(e.valueS))):i.select("circle").interrupt().attr("cy",l.yScale(e.valueY)).attr("cx",l.xScale(e.valueX)).attr("r",z.areaToRadius(l.sScale(e.valueS))).transition(),n||e.transparent||(n=!0,l._labels.updateLabelOnlyPosition(o,null,{scaledS0:z.areaToRadius(l.sScale(e.valueS))})),e.next){var a=e.next;if(null!=a&&null!=a.valueY&&null!=a.valueX){var r=Math.sqrt(Math.pow(l.xScale(e.valueX)-l.xScale(a.valueX),2)+Math.pow(l.yScale(e.valueY)-l.yScale(a.valueY),2));s?i.select("line").transition().duration(s).ease(d3.easeLinear).attr("x1",l.xScale(a.valueX)).attr("y1",l.yScale(a.valueY)).attr("x2",l.xScale(e.valueX)).attr("y2",l.yScale(e.valueY)).attr("stroke-dasharray",r).attr("stroke-dashoffset",z.areaToRadius(l.sScale(e.valueS))):i.select("line").interrupt().attr("x1",l.xScale(a.valueX)).attr("y1",l.yScale(a.valueY)).attr("x2",l.xScale(e.valueX)).attr("y2",l.yScale(e.valueY)).attr("stroke-dasharray",r).attr("stroke-dashoffset",z.areaToRadius(l.sScale(e.valueS))).transition()}}}})}},_recolor:function(e,t,i){var r=this.context;e.each(function(e,t){var i=d3.select(this),a="geo.world_4region"==r.model.marker.color.which?r.model.marker.color.getColorShade({colorID:e.valueC,shadeID:"shade"}):null!=e.valueC?r.cScale(e.valueC):r.COLOR_BLACKISH;i.select("circle").style("fill",null!=e.valueC?r.cScale(e.valueC):r.COLOR_WHITEISH),i.select("line").style("stroke",a)})},_opacityHandler:function(e,t,i){var a=this.context;e.each(function(e,t){d3.select(this).style("opacity",i.opacity||a.model.marker.opacityRegular)})},_findVisible:function(s,e,o){var l=this.context,n=this,c=l.KEY,h=l.dataKeys;return new Promise(function(r,e){new Promise(function(t,e){o.limits?t():l.model.marker.getEntityLimits(o[c]).then(function(e){o.limits=e,t()})}).then(function(){o.selectedEntityData.trailStartTime||(o.selectedEntityData.trailStartTime=l.model.time.formatDate(l.time));var a=l.model.time.parse(""+o.selectedEntityData.trailStartTime);if(l.time-a<0||0<o.limits.min-a){a=(l.time-a<0?o.selectedEntityData.trailStartTime=l.model.time.formatDate(d3.max([l.time,o.limits.min])):o.selectedEntityData.trailStartTime=l.model.time.formatDate(o.limits.min),l.model.time.parse(""+o.selectedEntityData.trailStartTime));var e=l._labels.cached[o[c]],t=l.frame.size[z.getKey(o,h.size)],i=l.frame.color[z.getKey(o,h.color)];e.labelX0=l.frame.axis_x[z.getKey(o,h.axis_x)],e.labelY0=l.frame.axis_y[z.getKey(o,h.axis_y)],e.scaledS0=t||0===t?z.areaToRadius(l.sScale(t)):null,e.scaledC0=null!=i?l.cScale(i):l.COLOR_WHITEISH,l._updateLabel(o,0,l.frame,e.labelX0,e.labelY0,t,i,l.frame.label[z.getKey(o,h.label)],l.frame.size_label[z.getKey(o,h.size_label)],0,!0)}s.each(function(e,t){var i=e.transparent;e.transparent=null==o.selectedEntityData.trailStartTime||0<e.t-l.time||0<a-e.t||0<=o.selectedEntityData.trailStartTime-l.model.time.formatDate(l.time),(i!=e.transparent||Math.abs(l.model.time.formatDate(e.t)-l.model.time.formatDate(l.time))<2)&&(e.visibilityChanged=!0),e.transparent&&d3.select(s._groups[0][t]).classed("vzb-invisible",e.transparent)}),n.drawingQueue[o[c]]={},n.delayedIterations[o[c]]={},r()})})},_abortAnimation:function(){var e=this.context,t=this,i=e.KEY;t.trailsData.forEach(function(e){t.trailTransitions[e[i]]&&t.trailTransitions[e[i]].select("line").interrupt().transition()})},_reveal:function(m,g,x){var v=this.context;v.model.time.playing&&(g=v.model.time.delay);var b=this,y=(v.KEYS,v.KEY),p=v.dataKeys;x.status="reveal";var d=v.model.time.parse(""+x.selectedEntityData.trailStartTime),f=function(n,c,h,e){return new Promise(function(s,e){var o=d3.select(n._groups[0][c]),l=o.datum();if(h-c==1){if(l.transparent)return o.classed("vzb-invisible",l.transparent),s();if(!l.visibilityChanged)return s()}v.model.marker.getFrame(l.t,function(e){if("reveal"!=x.status)return s();if(!e)return s();if(l.valueY=e.axis_y[z.getKey(x,p.axis_y)],l.valueX=e.axis_x[z.getKey(x,p.axis_x)],l.valueS=e.size[z.getKey(x,p.size)],l.valueC=e.color[z.getKey(x,p.color)],null==l.valueY||null==l.valueX||null==l.valueS)return s();if(d&&d.toString()==l.t.toString()){var t=v._labels.cached[x[y]];t.labelX0=l.valueX,t.labelY0=l.valueY;var i=l.valueS;t.scaledS0=i||0===i?z.areaToRadius(v.sScale(i)):null,t.scaledC0=null!=l.valueC?v.cScale(l.valueC):v.COLOR_WHITEISH,v._updateLabel(x,c,e,l.valueX,l.valueY,l.valueS,l.valueC,e.label[z.getKey(x,p.label)],e.size_label[z.getKey(x,p.size_label)],0,!0)}if(o.select("circle").attr("cy",v.yScale(l.valueY)).attr("cx",v.xScale(l.valueX)).attr("r",z.areaToRadius(v.sScale(l.valueS))).style("fill",null!=l.valueC?v.cScale(l.valueC):v.COLOR_WHITEISH),o.select("line").attr("x2",v.xScale(l.valueX)).attr("y2",v.yScale(l.valueY)).attr("x1",v.xScale(l.valueX)).attr("y1",v.yScale(l.valueY)),0<v.time-l.t?(l.visibilityChanged=!1,o.classed("vzb-invisible",l.transparent)):o.classed("vzb-invisible",!0),!n._groups[0][h]||v.time.toString()==l.t.toString())return s();var a=d3.select(n._groups[0][h]).datum(),r=((a.previous=l).next=a).t;v.time-a.t<0&&(l.visibilityChanged=!0,r=v.time),v.model.marker.getFrame(r,function(e){if("reveal"!=x.status)return s();if(!e||null==l.valueY||null==l.valueX||null==l.valueS)return s();if(null==e.axis_x[z.getKey(x,p.axis_x)]||null==e.axis_y[z.getKey(x,p.axis_y)])return s();a.valueY=e.axis_y[z.getKey(x,p.axis_y)],a.valueX=e.axis_x[z.getKey(x,p.axis_x)],a.valueS=e.size[z.getKey(x,p.size)],a.valueC=e.color[z.getKey(x,p.color)],b.trailTransitions[x[y]]=o;var t="geo.world_4region"==v.model.marker.color.which?v.model.marker.color.getColorShade({colorID:l.valueC,shadeID:"shade"}):null!=l.valueC?v.cScale(l.valueC):v.COLOR_BLACKISH,i=Math.sqrt(Math.pow(v.xScale(l.valueX)-v.xScale(a.valueX),2)+Math.pow(v.yScale(l.valueY)-v.yScale(a.valueY),2));return o.select("line").attr("stroke-dasharray",i).attr("stroke-dashoffset",z.areaToRadius(v.sScale(l.valueS))).style("stroke",t).transition().duration(g).ease(d3.easeLinear).attr("x1",v.xScale(a.valueX)).attr("y1",v.yScale(a.valueY)).attr("x2",v.xScale(l.valueX)).attr("y2",v.yScale(l.valueY)),1<h-c&&_(c,h),s()})})})},_=function(e,t,i){var a=void 0;1<t-e&&(a=r(e,t),b.delayedIterations[x[y]][e]={first:e,next:t,medium:a}),i&&1<i-t&&(a=r(t,i),b.delayedIterations[x[y]][t]={first:t,next:i,medium:a})},r=function(e,t){return Math.round(e+(t-e)/2)},S=function(){return new Promise(function(a,e){0<Object.keys(b.drawingQueue[x[y]]).length?function e(){var h,d,u,t=Object.keys(b.drawingQueue[x[y]])[Math.floor(Math.random()*Object.keys(b.drawingQueue[x[y]]).length)],i=JSON.parse(JSON.stringify(b.drawingQueue[x[y]][t]));delete b.drawingQueue[x[y]][t],(h=i.first,d=i.next,u=i.medium,new Promise(function(r,e){var s=d3.select(m._groups[0][h]),t=d3.select(m._groups[0][d]),o=d3.select(m._groups[0][u]),l=s.datum(),n=t.datum(),c=o.datum();if(!l.previous&&!l.next||!n.previous&&!n.next)return r();v.model.marker.getFrame(c.t,function(e){if("reveal"!=x.status)return r();if(!e||void 0===e.axis_x||null==e.axis_x[z.getKey(x,p.axis_x)]||void 0===e.axis_y||null==e.axis_y[z.getKey(x,p.axis_y)])return z.warn("Frame for trail missed: "+c.t),r();if(c.valueY=e.axis_y[z.getKey(x,p.axis_y)],c.valueX=e.axis_x[z.getKey(x,p.axis_x)],c.valueS=e.size[z.getKey(x,p.size)],c.valueC=e.color[z.getKey(x,p.color)],c.previous=l,c.next=n,l.next=c,null==(n.previous=c).valueY||null==c.valueX||null==c.valueS)return z.warn("Data for trail point missed: "+c.t),r();var t="geo.world_4region"==v.model.marker.color.which?v.model.marker.color.getColorShade({colorID:c.valueC,shadeID:"shade"}):null!=c.valueC?v.cScale(c.valueC):v.COLOR_BLACKISH,i=Math.sqrt(Math.pow(v.xScale(l.valueX)-v.xScale(c.valueX),2)+Math.pow(v.yScale(l.valueY)-v.yScale(c.valueX),2));if(s.select("line").transition().duration(g).ease(d3.easeLinear).attr("x1",v.xScale(c.valueX)).attr("y1",v.yScale(c.valueY)).attr("x2",v.xScale(l.valueX)).attr("y2",v.yScale(l.valueY)).attr("stroke-dasharray",i).attr("stroke-dashoffset",z.areaToRadius(v.sScale(l.valueS))).style("stroke",t),o.classed("vzb-invisible",c.transparent),!c.transparent){o.select("circle").attr("cy",v.yScale(c.valueY)).attr("cx",v.xScale(c.valueX)).attr("r",z.areaToRadius(v.sScale(c.valueS))).style("fill",null!=c.valueC?v.cScale(c.valueC):v.COLOR_WHITEISH);var a=Math.sqrt(Math.pow(v.xScale(c.valueX)-v.xScale(n.valueX),2)+Math.pow(v.yScale(c.valueY)-v.yScale(n.valueY),2));o.select("line").transition().duration(g).ease(d3.easeLinear).attr("x1",v.xScale(n.valueX)).attr("y1",v.yScale(n.valueY)).attr("x2",v.xScale(c.valueX)).attr("y2",v.yScale(c.valueY)).attr("stroke-dasharray",a).attr("stroke-dashoffset",z.areaToRadius(v.sScale(c.valueS))).style("stroke",t)}_(h,u,d),r()})})).then(function(){0<Object.keys(b.drawingQueue[x[y]]).length?e():a()})}(b.drawingQueue[x[y]]):a()})};return new Promise(function(a,e){var t,i,r,s,o,l,n,c;if(v.model.marker.framesAreReady())!function e(t,i){if(i<0||i>=t._groups[0].length)return a();f(t,i,i+1).then(function(){e(t,i+1)},function(){return a()})}(m,0);else{b.delayedIterations[x[y]]={},b.drawingQueue[x[y]]={};var h=(t=x,i=m,r=50,s=[],l=o=0,n=d3.min([t.limits.max,v.time]),c=d3.max([t.limits.min,v.model.time.parse(""+t.selectedEntityData.trailStartTime)]),z.forEach(i._groups[0],function(e,t){var i=e.__data__;i.t-c==0?o=t:i.t-n==0?l=t:i.t>c&&i.t<n&&(v.model.time.formatDate(i.t)%r==0||i.next&&i.previous)&&s.push(t)}),s.unshift(o),0<l&&s.push(l),s),d=[];if(h.length<=1)return a();b.delayedIterations[x[y]]={};for(var u=0;u<h.length-1;u++)d.push(f(m,h[u],h[u+1]));Promise.all(d).then(function(){0==Object.keys(b.delayedIterations[x[y]]).length?a():(b.drawingQueue[x[y]]=b.delayedIterations[x[y]],b.delayedIterations[x[y]]={},function e(){S().then(function(){if(0==Object.keys(b.delayedIterations[x[y]]).length)return a();b.drawingQueue[x[y]]=b.delayedIterations[x[y]],b.delayedIterations[x[y]]={},e()},function(){return a()})}())},function(){a()})}})}});t.default=s},function(i,e,t){(function(e){var t;t=void 0!==e?e:this,i.exports=function(e){if(e.CSS&&e.CSS.escape)return e.CSS.escape;var t=function(e){if(0==arguments.length)throw new TypeError("`CSS.escape` requires an argument.");for(var t,i=String(e),a=i.length,r=-1,s="",o=i.charCodeAt(0);++r<a;)0!=(t=i.charCodeAt(r))?s+=1<=t&&t<=31||127==t||0==r&&48<=t&&t<=57||1==r&&48<=t&&t<=57&&45==o?"\\"+t.toString(16)+" ":0==r&&1==a&&45==t||!(128<=t||45==t||95==t||48<=t&&t<=57||65<=t&&t<=90||97<=t&&t<=122)?"\\"+i.charAt(r):i.charAt(r):s+="�";return s};return e.CSS||(e.CSS={}),e.CSS.escape=t}(t)}).call(this,t(6))},function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var O=Vizabi.utils,a=Vizabi.Class.extend({init:function(e){this.context=e,this.dragRectangle=d3.drag(),this.zoomer=d3.zoom(),this.dragRectangle.subject(this.dragSubject()).on("start",this.drag().start).on("drag",this.drag().go).on("end",this.drag().stop),this.zoomer.filter(this.zoomFilter()).scaleExtent([.0625,1/0]).on("start",this.zoom().start).on("zoom",this.zoom().go).on("end",this.zoom().stop),this.zoomer.ratioX=1,this.zoomer.ratioY=1,e._zoomedXYMinMax={axis_x:{zoomedMin:null,zoomedMax:null},axis_y:{zoomedMin:null,zoomedMax:null}}},dragSubject:function(){var t=this.context;return function(e){return!d3.event.sourceEvent.ctrlKey&&!d3.event.sourceEvent.metaKey&&"plus"!==t.ui.cursorMode||"minus"===t.ui.cursorMode||("touchmove"===d3.event.sourceEvent.type||"touchstart"===d3.event.sourceEvent.type)&&(1<d3.event.sourceEvent.touches.length||1<d3.event.sourceEvent.targetTouches.length)?null:{x:d3.mouse(this)[0],y:d3.mouse(this)[1]}}},drag:function(){var r=this.context,i=this;return{start:function(e,t){this.origin={x:d3.mouse(this)[0],y:d3.mouse(this)[1]},r.zoomRect.classed("vzb-invisible",!1)},go:function(e,t){var i=this.origin,a={x:d3.event.x,y:d3.event.y};r.zoomRect.attr("x",Math.min(a.x,i.x)).attr("y",Math.min(a.y,i.y)).attr("width",Math.abs(a.x-i.x)).attr("height",Math.abs(a.y-i.y))},stop:function(e){if(r.zoomRect.attr("width",0).attr("height",0).classed("vzb-invisible",!0),this.target={x:d3.mouse(this)[0],y:d3.mouse(this)[1]},!(Math.abs(this.origin.x-this.target.x)<10||Math.abs(this.origin.y-this.target.y)<10)){var t=d3.event.sourceEvent.ctrlKey||d3.event.sourceEvent.metaKey||"plus"===r.ui.cursorMode;i._zoomOnRectangle(d3.select(this),this.origin.x,this.origin.y,this.target.x,this.target.y,t,500)}}}},zoomFilter:function(){var i=this.context;return function(e){var t=d3.event;return!t.ctrlKey&&!t.metaKey&&(("touchmove"===t.type||"touchstart"===t.type)&&(1<t.touches.length||1<t.targetTouches.length)||(!("wheel"!==t.type&&"mousewheel"!==t.type||!i.ui.zoomOnScrolling)||!("mousedown"!==t.type&&"touchstart"!==t.type||"plus"===i.ui.cursorMode||"minus"===i.ui.cursorMode||!i.ui.panWithArrow&&"hand"!==i.ui.cursorMode)))}},zoom:function(){var E=this.context,T=this.zoomer,C=this;return{start:function(){"plus"!==E.ui.cursorMode&&"minus"!==E.ui.cursorMode&&E.chartSvg.classed("vzb-zooming",!0),E.model._data.marker.clearHighlighted(),E._setTooltip()},go:function(){var e=d3.event.sourceEvent,t=d3.event.transform.k,i=[d3.event.transform.x,d3.event.transform.y],a=T.ratioY,r=T.ratioX;E.draggingNow=!0,(isNaN(t)||null==t)&&(t=T.scale),(isNaN(t)||null==t)&&(t=1),1===t&&null!==e&&(("wheel"===e.type||"mousewheel"===e.type)&&0<(e.deltaY||-e.wheelDelta)||"touchmove"===e.type&&1<e.touches.length)&&(r=T.ratioX=1,a=T.ratioY=1),(isNaN(i[0])||isNaN(i[1])||null==i[0]||null==i[1])&&(i=[0,0]);var s=T.scaleExtent()[0];t*a<s&&(a=s/t,T.ratioY=a),t*r<s&&(r=s/t,T.ratioX=r);var o=t*r<1,l=t*a<1;o?(i[0]<0&&(i[0]=0),i[0]>(1-t*r)*E.width&&(i[0]=(1-t*r)*E.width)):(0<i[0]&&(i[0]=0),i[0]<(1-t*r)*E.width&&(i[0]=(1-t*r)*E.width)),l?(i[1]<0&&(i[1]=0),i[1]>(1-t*a)*E.height&&(i[1]=(1-t*a)*E.height)):(0<i[1]&&(i[1]=0),i[1]<(1-t*a)*E.height&&(i[1]=(1-t*a)*E.height)),C.zoomSelection.property("__zoom",d3.zoomIdentity.translate(i[0],i[1]).scale(t));var n=E.width*t*r,c=E.height*t*a,h=[0*t*r+i[0],n+i[0]],d=[c+i[1],0*t*a+i[1]],u=E._rangeBump(h),m=E._rangeBump(d),g=(u[0]-h[0])*t*r,x=(u[1]-h[1])*t*r,v=(m[0]-d[0])*t*a,b=(m[1]-d[1])*t*a;h[0]+=g,h[1]+=x,d[0]+=v,d[1]+=b;var y=[0,E.width],p=[E.height,0],f=E._rangeBump(y),_=E._rangeBump(p);o?(h[0]<f[0]&&(i[0]=f[0]-g),h[1]>f[1]&&(i[0]=f[1]-x-n)):(h[0]>f[0]&&(i[0]=f[0]-g),h[1]<f[1]&&(i[0]=f[1]-x-n)),l?(d[0]>_[0]&&(i[1]=_[0]-v-c),d[1]<_[1]&&(i[1]=_[1]-b)):(d[0]<_[0]&&(i[1]=_[0]-v-c),d[1]>_[1]&&(i[1]=_[1]-b)),o?(h[0]<f[0]&&(h[1]+=Math.abs(h[0]-f[0]),h[0]=f[0]),h[1]>f[1]&&(h[0]-=Math.abs(h[1]-f[1]),h[1]=f[1])):(h[0]>f[0]&&(h[1]-=Math.abs(h[0]-f[0]),h[0]=f[0]),h[1]<f[1]&&(h[0]+=Math.abs(h[1]-f[1]),h[1]=f[1])),l?(d[0]>_[0]&&(d[1]-=Math.abs(d[0]-_[0]),d[0]=_[0]),d[1]<_[1]&&(d[0]+=Math.abs(d[1]-_[1]),d[1]=_[1])):(d[0]<_[0]&&(d[1]+=Math.abs(d[0]-_[0]),d[0]=_[0]),d[1]>_[1]&&(d[0]-=Math.abs(d[1]-_[1]),d[1]=_[1])),"ordinal"===E.model.marker.axis_x.scaleType?E.xScale.rangeBands(h):E.xScale.range(h),"ordinal"===E.model.marker.axis_y.scaleType?E.yScale.rangeBands(d):E.yScale.range(d);var S=function(e){return O.isDate(e)?e:+e.toFixed(2)},z=f,k=_;E._zoomedXYMinMax={axis_x:{zoomedMin:S(E.xScale.invert(z[0])),zoomedMax:S(E.xScale.invert(z[1]))},axis_y:{zoomedMin:S(E.yScale.invert(k[0])),zoomedMax:S(E.yScale.invert(k[1]))}},T.dontFeedToState||E.model.marker.set(E._zoomedXYMinMax,null,!1);var M=E.yAxis.labelerOptions(),w=E.xAxis.labelerOptions();M.limitMaxTickNumber=t*a<1.5?8:t*a*8,w.limitMaxTickNumber=t*r<1.5?8:t*r*8,M.transitionDuration=T.duration,w.transitionDuration=T.duration,E.xAxisEl.call(E.xAxis.labelerOptions(w)),E.yAxisEl.call(E.yAxis.labelerOptions(M)),E.redrawDataPoints(T.duration),E._trails.run("resize",null,T.duration),T.duration=0},stop:function(){E.chartSvg.classed("vzb-zooming",!1),E.draggingNow=!1,T.dontFeedToState||E.model.marker.set(E._zoomedXYMinMax,!0,!0),T.dontFeedToState=null}}},expandCanvas:function(e){var t=this.context;e||(e=t.duration);var i=d3.extent(O.values(t.frame.axis_x)),a=d3.extent(O.values(t.frame.axis_y));if(!i[0]&&0!==i[0]||!i[1]&&0!==i[1]||!a[0]&&0!==a[0]||!a[1]&&0!==a[1])return O.warn("panZoom.expandCanvas: X or Y min/max are broken. Aborting with no action");var r={x1:t.xScale(i[0]),y1:t.yScale(a[0]),x2:t.xScale(i[1]),y2:t.yScale(a[1])},s=[0,t.width],o=[t.height,0],l=s[0],n=s[1],c=o[0],h=o[1];if(!t.isCanvasPreviouslyExpanded||r.x1<1*l||r.x2>1*n||r.y2<1*h||r.y1>1*c){if(t.isCanvasPreviouslyExpanded){var d=t._rangeBump(s),u=t._rangeBump(o);r.x1>d[0]&&(r.x1=d[0]),r.x2<d[1]&&(r.x2=d[1]),r.y1<u[0]&&(r.y1=u[0]),r.y2>u[0]&&(r.y2=u[1])}t.isCanvasPreviouslyExpanded=!0,this._zoomOnRectangle(t.element,r.x1,r.y1,r.x2,r.y2,!1,e)}else t.redrawDataPoints(e)},zoomToMaxMin:function(e,t,i,a,r,s){var o=this.context,l=e,n=t,c=i,h=a,d=o.xScale.domain(),u=o.yScale.domain();l<d[0]&&n<d[1]&&(l=d[0]),l>d[0]&&n>d[1]&&(n=d[1]),c<u[0]&&h<u[1]&&(c=u[0]),c>u[0]&&h>u[1]&&(h=u[1]);var m=[o.xScale(l),o.xScale(n)],g=[o.yScale(c),o.yScale(h)];this._zoomOnRectangle(o.element,m[0],g[0],m[1],g[1],!1,r,s)},_zoomOnRectangle:function(e,t,i,a,r,s,o,l){var n=this.context,c=this.zoomer,h=d3.zoomTransform(this.zoomSelection.node()),d=t,u=i,m=a,g=r;s&&h.translate(d-m,u-g);var x=[0,n.width],v=[n.height,0],b=n._rangeBump(x),y=n._rangeBump(v),p=c.scaleExtent()[0],f=c.scaleExtent()[1],_=void 0,S=void 0,z=void 0;if(d==m||u==g||b[0]==b[1]||y[0]==y[1])return O.warn("_zoomOnRectangle(): can not proceed because this may result in infinity zooms");Math.abs(d-m)>Math.abs(u-g)?((_=Math.abs(y[0]-y[1])/Math.abs(u-g)*h.k)<p&&(c.ratioY*=_/h.k,_=p),f<_&&(_=f),S=Math.abs(b[0]-b[1])/Math.abs(d-m)*h.k/_*c.ratioX,z=c.ratioY):((_=Math.abs(b[0]-b[1])/Math.abs(d-m)*h.k)<p&&(c.ratioX*=_/h.k,_=p),f<_&&(_=f),z=Math.abs(y[0]-y[1])/Math.abs(u-g)*h.k/_*c.ratioY,S=c.ratioX);var k=[(h.x-Math.min(d,m))/h.k/c.ratioX*_*S+(b[0]-x[0]),(h.y-Math.min(u,g))/h.k/c.ratioY*_*z+(y[1]-v[1])];c.dontFeedToState=l,c.ratioY=z||1,c.ratioX=S||1,c.duration=o||0,this.zoomSelection.call(c.transform,d3.zoomIdentity.translate(k[0],k[1]).scale(_))},zoomByIncrement:function(e,t){this.context;var i=d3.zoomTransform(this.zoomSelection.node()),a=i.k,r=[i.x,i.y],s=d3.mouse(this.zoomSelection.node()),o=Math.log(a)/Math.LN2;"plus"!=e&&e||(o=Math.floor(o)+1),"minus"==e&&(o=Math.ceil(o)-1);var l=[(s[0]-r[0])/a,(s[1]-r[1])/a],n=this.zoomer.scaleExtent();a==n[0]&&(this.zoomer.ratioY=1,this.zoomer.ratioX=1),a=Math.max(n[0],Math.min(n[1],Math.pow(2,o))),l=[l[0]*a+r[0],l[1]*a+r[1]],r[0]+=s[0]-l[0],r[1]+=s[1]-l[1],this.zoomer.duration=t||0,this.zoomSelection.call(this.zoomer.transform,d3.zoomIdentity.translate(r[0],r[1]).scale(a))},resetZoomState:function(e){this.zoomer.ratioY=1,this.zoomer.ratioX=1,(e||this.zoomSelection).property("__zoom",d3.zoomIdentity)},reset:function(e,t){this.context.isCanvasPreviouslyExpanded=!1,this.zoomer.ratioY=1,this.zoomer.ratioX=1,this.zoomer.duration=t||0,(e||this.zoomSelection).call(this.zoomer.transform,d3.zoomIdentity)},rerun:function(e){this.context;(e||this.zoomSelection).call(this.zoomer.scaleBy,1)},zoomSelection:function(e){this.zoomSelection=e}});t.default=a},function(e,t){e.exports='\x3c!-- Bubble Chart Component --\x3e\n<div class="vzb-bubblechart">\n    <svg class="vzb-bubblechart-svg vzb-export">\n        <g class="vzb-bc-graph">\n            <g class="vzb-bc-year"></g>\n\n            <g class="vzb-bc-axis-x-title"></g>\n            <g class="vzb-bc-axis-x-info vzb-noexport"></g>\n            <svg class="vzb-bc-axis-x"><g></g></svg>\n\n            <g class="vzb-bc-axis-y-title"></g>\n            <g class="vzb-bc-axis-y-info vzb-noexport"></g>\n            <svg class="vzb-bc-axis-y"><g></g></svg>\n\n            <line class="vzb-bc-projection-x"></line>\n            <line class="vzb-bc-projection-y"></line>\n\n            <svg class="vzb-bc-bubbles-crop">\n                <g class="vzb-zoom-selection"></g>\n                <rect class="vzb-bc-eventarea"></rect>\n                <g class="vzb-bc-decorations">\n                    <line class="vzb-bc-line-equal-xy vzb-invisible"></line>\n                    <g class="vzb-bc-x-axis-groups"></g>\n                </g>\n                <g class="vzb-bc-trails"></g>\n                <g class="vzb-bc-bubbles"></g>\n                <g class="vzb-bc-lines"></g>\n                <g class="vzb-bc-bubble-crown vzb-hidden">\n                    <circle class="vzb-crown-glow"></circle>\n                    <circle class="vzb-crown"></circle>\n                </g>\n                <rect class="vzb-bc-forecastoverlay vzb-hidden" x="0" y="0" width="100%" height="100%" fill="url(#vzb-bc-pattern-lines)" pointer-events=\'none\'></rect>\n            </svg>\n\n            <g class="vzb-bc-axis-y-subtitle"></g>\n            <g class="vzb-bc-axis-x-subtitle"></g>\n            <g class="vzb-bc-axis-s-title"></g>\n            <g class="vzb-bc-axis-c-title"></g>\n\n            <svg class="vzb-bc-labels-crop">\n                <g class="vzb-bc-labels"></g>\n            </svg>\n\n            <g class="vzb-data-warning vzb-noexport">\n                <svg></svg>\n                <text></text>\n            </g>\n\n            <rect class="vzb-bc-zoom-rect"></rect>\n        </g>\n    </svg>\n    <svg>\n        <defs>\n            <filter id="vzb-glow-filter" x="-50%" y="-50%" width="200%" height="200%">\n                <feGaussianBlur in="SourceGraphic" stdDeviation="2"></feGaussianBlur>\n            </filter>\n\t        <pattern id="vzb-bc-pattern-lines" x="0" y="0" patternUnits="userSpaceOnUse" width="50" height="50" viewBox="0 0 10 10"> \n              <path d=\'M-1,1 l2,-2M0,10 l10,-10M9,11 l2,-2\' stroke=\'black\' stroke-width=\'3\' opacity=\'0.08\'/>\n            </pattern> \n        </defs>\n    </svg>\n    \x3c!-- This could possibly be another component --\x3e\n    <div class="vzb-tooltip vzb-hidden vzb-tooltip-mobile"></div>\n</div>\n'}]);
//# sourceMappingURL=bubblechart.min.js.map